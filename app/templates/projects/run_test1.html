{% extends '_partials/base.html' %}
{% load static %}




{% block title %}Job Application Wizard | Potenza{% endblock %}

{% block content %}
<div id="container">
    <div id="top-wizard">
        <span id="location"></span>
        <div id="progressbar"></div>
    </div>

    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="p-4 rounded {{ message.tags }} bg-green-100 text-green-800">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    <!-- <form method="post" class="text-center">
        {% csrf_token %}
        <button type="submit"
            class="btn" style="background-color: #1dbe72; color: #fff;">
            üöÄ Launch tests on TestLink
        </button>
    </form> -->
    <h2 class="">Select a project to launch the test</h2>

    <div style="display: flex; gap: 15px; align-items: center;">
        <div class="container py-5 h-100">
            <div class="row d-flex align-items-center h-100">
            {% for project in projects %}
                <!-- <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 10px;">
                    <strong>{{ project.name }} ({{ project.key }})</strong>
                    <form method="POST" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="jira_key" value="{{ project.key }}">
                        <button type="submit" class="btn btn-success" style="background-color: #1dbe72; border: none;">üöÄ Run Test</button>
                    </form>
                </div> -->
                <div class="col col-lg-6 mb-4 mb-lg-0">
                    <figure class="bg-white p-4 rounded shadow-sm" style="border-left: .25rem solid #1dbe72;">
                        <figcaption class="mb-3">
                            <div class="d-flex justify-content-between">
                                <h5 class="mb-4"> {{ project.name }} ({{ project.key }})</h5>
                                <div class="text-muted" id="percentage-{{ project.key }}">
                                    <h5 class="percentage-value text-muted">{{ project.percentage }}%</h5>
                                </div>
                            </div>
                            <form method="POST" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="jira_key" value="{{ project.key }}">
                                <button type="submit" class="btn btn-success" style="background-color: #1dbe72; border: none;">üöÄ Run Test</button>
                            </form>

                            <!-- Button to open modal -->
                            <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modal-{{ project.key }}">
                                üìã View Steps
                            </button>
                        </figcaption>
                    </figure>
                </div>

                <!-- Modal for steps -->
                <div class="modal fade" id="modal-{{ project.key }}" tabindex="-1" aria-labelledby="modalLabel-{{ project.key }}" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalLabel-{{ project.key }}">√âtapes pour {{ project.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                            </div>
                            <!-- <div class="modal-body">
                                {% if project.steps %}
                                    <ul class="list-group">
                                        {% for step in project.steps %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                   <strong>{{ step.title }}</strong>
                                                </div>
                                                <select name="status_{{ step.id }}">
                                                    <option value="not tested">‚úÖ Non tested</option>
                                                    <option value="correct">‚úÖ Correct</option>
                                                    <option value="incorrect">‚ùå Incorrect</option>
                                                </select>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p>Aucune √©tape trouv√©e pour ce projet.</p>
                                {% endif %}
                            </div> -->
                            <div class="modal-body">
                                {% if project.steps %}
                                    <div class="list-group">
                                        {% for step in project.steps %}
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                                    <div class="mb-2 mb-md-0" style="flex: 1 1 auto;">
                                                        <h6 class="mb-0 text-dark">{{ step.title }}</h6>
                                                    </div>
                                                    <div style="min-width: 180px;">
                                                        <!-- <select name="status_{{ step.id }}" class="form-select">
                                                            <option value="not tested">üïì Non test√©</option>
                                                            <option value="correct">‚úÖ Correct</option>
                                                            <option value="incorrect">‚ùå Incorrect</option>
                                                        </select> -->
                                                        <select name="status_{{ step.id }}" class="form-select" data-project-key="{{ project.key }}">
                                                            <option value="not tested" {% if step.status == "not tested" %}selected{% endif %}>üïì Not tested</option>
                                                            <option value="correct" {% if step.status == "correct" %}selected{% endif %}>‚úÖ Correct</option>
                                                            <option value="incorrect" {% if step.status == "incorrect" %}selected{% endif %}>‚ùå Incorrect</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning mb-0">Aucune √©tape trouv√©e pour ce projet.</div>
                                {% endif %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>

            {% endfor %}
            {% if not projects %}
                <p>Aucun projet trouv√©.</p>
            {% endif %}
        </div>
    </div>
</div>


<script>
    document.querySelectorAll('select[name^="status_"]').forEach(select => {
        select.addEventListener("change", function () {
            const stepId = this.name.split("_")[1];
            const status = this.value;
            const projectKey = this.dataset.projectKey;

            fetch("{% url 'update_step_status' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `step_id=${stepId}&status=${status}`,
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert("Erreur lors de l‚Äôenregistrement");
                } else {
                    const selects = document.querySelectorAll(`select[data-project-key="${projectKey}"]`);
                    let total = 0;
                    let correct = 0;

                    selects.forEach(sel => {
                        total += 1;
                        if (sel.value === "correct") correct += 1;
                    });

                    const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
                    const percentageEl = document.getElementById(`percentage-${projectKey}`);
                    if (percentageEl) {
                        percentageEl.textContent = `${percentage}%`;
                    }
                }
            });
        });
    });
</script>

{% endblock content %}